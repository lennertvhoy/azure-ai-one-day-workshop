{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "777426385202114572"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region for deployment"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource group name for the AVD lab"
      }
    },
    "namingPrefix": {
      "type": "string",
      "defaultValue": "avd",
      "metadata": {
        "description": "Naming prefix for resources"
      }
    },
    "namingSuffix": {
      "type": "string",
      "defaultValue": "lab",
      "metadata": {
        "description": "Naming suffix for resources"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "VM size for session hosts"
      }
    },
    "vmImage": {
      "type": "object",
      "defaultValue": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "windows-11",
        "sku": "win11-23h2-pro",
        "version": "latest"
      },
      "metadata": {
        "description": "VM image reference for session hosts"
      }
    },
    "hostPoolType": {
      "type": "string",
      "defaultValue": "Pooled",
      "metadata": {
        "description": "Host pool type: Pooled or Personal"
      }
    },
    "loadBalancerType": {
      "type": "string",
      "defaultValue": "BreadthFirst",
      "metadata": {
        "description": "Load balancer type: BreadthFirst, DepthFirst, or Persistent"
      }
    },
    "maxSessionsPerHost": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "Maximum sessions per host"
      }
    },
    "numberOfSessionHosts": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Number of session hosts to deploy"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Virtual network address prefix"
      }
    },
    "subnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/24",
      "metadata": {
        "description": "Subnet address prefix"
      }
    },
    "aadJoinType": {
      "type": "string",
      "defaultValue": "AzureAD",
      "metadata": {
        "description": "AAD join type: AzureAD or ActiveDirectory"
      }
    },
    "domainJoinUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Domain join username (for ActiveDirectory join)"
      }
    },
    "domainJoinPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Domain join password (for ActiveDirectory join)"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "avdadmin",
      "metadata": {
        "description": "Local administrator username"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Local administrator password"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "managed-by": "avd-lab-tool"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "expiry": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Expiry time for the lab environment (ISO8601)"
      }
    }
  },
  "variables": {
    "hostPoolName": "[format('{0}-hp-{1}', parameters('namingPrefix'), parameters('namingSuffix'))]",
    "workspaceName": "[format('{0}-ws-{1}', parameters('namingPrefix'), parameters('namingSuffix'))]",
    "dagName": "[format('{0}-dag-{1}', parameters('namingPrefix'), parameters('namingSuffix'))]",
    "vnetName": "[format('{0}-vnet-{1}', parameters('namingPrefix'), parameters('namingSuffix'))]",
    "subnetName": "default",
    "nsgName": "[format('{0}-nsg-{1}', parameters('namingPrefix'), parameters('namingSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[union(parameters('tags'), createObject('expiry', parameters('expiry'), 'lab-name', parameters('namingSuffix')))]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "subnetName": {
            "value": "[variables('subnetName')]"
          },
          "nsgName": {
            "value": "[variables('nsgName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('subnetAddressPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "4534716482558804174"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual network name"
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "Subnet name"
              }
            },
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "Network security group name"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Virtual network address prefix"
              }
            },
            "subnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Subnet address prefix"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[parameters('nsgName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowRdpInbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound",
                      "description": "Allow RDP access for AVD"
                    }
                  },
                  {
                    "name": "AllowAzureGatewayInbound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound",
                      "description": "Allow Azure Gateway Manager"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerInbound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound",
                      "description": "Allow Azure Load Balancer"
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('subnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Disabled"
                    }
                  }
                ],
                "enableDdosProtection": false
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnetName')]"
            },
            "subnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[0].id]"
            },
            "subnetName": {
              "type": "string",
              "value": "[parameters('subnetName')]"
            },
            "nsgId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "hostpool-deployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "hostPoolName": {
            "value": "[variables('hostPoolName')]"
          },
          "hostPoolType": {
            "value": "[parameters('hostPoolType')]"
          },
          "loadBalancerType": {
            "value": "[parameters('loadBalancerType')]"
          },
          "maxSessionsPerHost": {
            "value": "[parameters('maxSessionsPerHost')]"
          },
          "tags": {
            "value": "[union(parameters('tags'), createObject('expiry', parameters('expiry'), 'lab-name', parameters('namingSuffix')))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "2243937286283616446"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment"
              }
            },
            "hostPoolName": {
              "type": "string",
              "metadata": {
                "description": "Host pool name"
              }
            },
            "hostPoolType": {
              "type": "string",
              "defaultValue": "Pooled",
              "allowedValues": [
                "Pooled",
                "Personal"
              ],
              "metadata": {
                "description": "Host pool type: Pooled or Personal"
              }
            },
            "loadBalancerType": {
              "type": "string",
              "defaultValue": "BreadthFirst",
              "allowedValues": [
                "BreadthFirst",
                "DepthFirst",
                "Persistent"
              ],
              "metadata": {
                "description": "Load balancer type: BreadthFirst, DepthFirst, or Persistent"
              }
            },
            "maxSessionsPerHost": {
              "type": "int",
              "defaultValue": 10,
              "metadata": {
                "description": "Maximum sessions per host"
              }
            },
            "preferredAppGroupType": {
              "type": "string",
              "defaultValue": "Desktop",
              "metadata": {
                "description": "Preferred app group type"
              }
            },
            "customRdpProperties": {
              "type": "string",
              "defaultValue": "drivestoredirect:s:*;audiomode:i:0;videoplaybackmode:i:1;redirectclipboard:i:1;redirectprinters:i:1;devicestoredirect:s:*;redirectcomports:i:1;redirectsmartcards:i:1;usbdevicestoredirect:s:*;enablecredsspsupport:i:1;use multimon:i:1",
              "metadata": {
                "description": "Custom RDP properties"
              }
            },
            "validationEnv": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Validation environment"
              }
            },
            "registrationTokenExpiration": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'PT8H')]",
              "metadata": {
                "description": "Registration token expiration time (ISO8601)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2023-09-05",
              "name": "[parameters('hostPoolName')]",
              "location": "[parameters('location')]",
              "properties": {
                "hostPoolType": "[parameters('hostPoolType')]",
                "loadBalancerType": "[parameters('loadBalancerType')]",
                "preferredAppGroupType": "[parameters('preferredAppGroupType')]",
                "maxSessionLimit": "[parameters('maxSessionsPerHost')]",
                "customRdpProperty": "[parameters('customRdpProperties')]",
                "validationEnvironment": "[parameters('validationEnv')]",
                "ring": "[if(parameters('validationEnv'), 1, 0)]",
                "registrationInfo": {
                  "expirationTime": "[parameters('registrationTokenExpiration')]",
                  "registrationTokenOperation": "Update"
                },
                "ssoadfsAuthority": "",
                "ssoClientId": "",
                "ssoClientSecretKeyVaultPath": "",
                "ssoSecretType": "SharedKey",
                "startVMOnConnect": true
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "hostPoolId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]"
            },
            "hostPoolName": {
              "type": "string",
              "value": "[parameters('hostPoolName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "workspace-deployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceName": {
            "value": "[variables('workspaceName')]"
          },
          "tags": {
            "value": "[union(parameters('tags'), createObject('expiry', parameters('expiry'), 'lab-name', parameters('namingSuffix')))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "13981659592221715972"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment"
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Workspace name"
              }
            },
            "workspaceFriendlyName": {
              "type": "string",
              "defaultValue": "AVD Lab Workspace",
              "metadata": {
                "description": "Workspace friendly name"
              }
            },
            "workspaceDescription": {
              "type": "string",
              "defaultValue": "AVD Lab Workspace for Course Testing",
              "metadata": {
                "description": "Workspace description"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2023-09-05",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "friendlyName": "[parameters('workspaceFriendlyName')]",
                "description": "[parameters('workspaceDescription')]",
                "publicNetworkAccess": "Enabled"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[parameters('workspaceName')]"
            },
            "workspaceUrl": {
              "type": "string",
              "value": "https://rdweb.wvd.microsoft.com/api/arm/feeddiscovery"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appgroup-deployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "dagName": {
            "value": "[variables('dagName')]"
          },
          "hostPoolName": {
            "value": "[variables('hostPoolName')]"
          },
          "workspaceName": {
            "value": "[variables('workspaceName')]"
          },
          "tags": {
            "value": "[union(parameters('tags'), createObject('expiry', parameters('expiry'), 'lab-name', parameters('namingSuffix')))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17506867634262993757"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment"
              }
            },
            "dagName": {
              "type": "string",
              "metadata": {
                "description": "Desktop Application Group name"
              }
            },
            "hostPoolName": {
              "type": "string",
              "metadata": {
                "description": "Host pool name to associate with"
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Workspace name to associate with"
              }
            },
            "applicationGroupType": {
              "type": "string",
              "defaultValue": "Desktop",
              "metadata": {
                "description": "Application group type"
              }
            },
            "friendlyName": {
              "type": "string",
              "defaultValue": "Desktop Application Group",
              "metadata": {
                "description": "Friendly name for the application group"
              }
            },
            "appGroupDescription": {
              "type": "string",
              "defaultValue": "Desktop Application Group for AVD Lab",
              "metadata": {
                "description": "Description text for the application group"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2023-09-05",
              "name": "[parameters('dagName')]",
              "location": "[parameters('location')]",
              "properties": {
                "applicationGroupType": "[parameters('applicationGroupType')]",
                "friendlyName": "[parameters('friendlyName')]",
                "description": "[parameters('appGroupDescription')]",
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces/applicationGroups",
              "apiVersion": "2023-09-05",
              "name": "[format('{0}/{1}', parameters('workspaceName'), parameters('dagName'))]",
              "properties": {
                "applicationGroupPath": "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('dagName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('dagName'))]"
              ]
            }
          ],
          "outputs": {
            "dagId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('dagName'))]"
            },
            "dagName": {
              "type": "string",
              "value": "[parameters('dagName')]"
            },
            "dagType": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('dagName')), '2023-09-05').applicationGroupType]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'hostpool-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'workspace-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sessionhosts-deployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "hostPoolName": {
            "value": "[variables('hostPoolName')]"
          },
          "numberOfHosts": {
            "value": "[parameters('numberOfSessionHosts')]"
          },
          "vmSize": {
            "value": "[parameters('vmSize')]"
          },
          "vmImage": {
            "value": "[parameters('vmImage')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "subnetName": {
            "value": "[variables('subnetName')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "aadJoinType": {
            "value": "[parameters('aadJoinType')]"
          },
          "domainJoinUsername": {
            "value": "[parameters('domainJoinUsername')]"
          },
          "domainJoinPassword": {
            "value": "[parameters('domainJoinPassword')]"
          },
          "namingPrefix": {
            "value": "[parameters('namingPrefix')]"
          },
          "namingSuffix": {
            "value": "[parameters('namingSuffix')]"
          },
          "tags": {
            "value": "[union(parameters('tags'), createObject('expiry', parameters('expiry'), 'lab-name', parameters('namingSuffix')))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "6618007618693635954"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment"
              }
            },
            "hostPoolName": {
              "type": "string",
              "metadata": {
                "description": "Host pool name to register session hosts with"
              }
            },
            "numberOfHosts": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 1,
              "maxValue": 100,
              "metadata": {
                "description": "Number of session hosts to deploy"
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v3",
              "metadata": {
                "description": "VM size for session hosts"
              }
            },
            "vmImage": {
              "type": "object",
              "metadata": {
                "description": "VM image reference"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual network name"
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "Subnet name"
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Local administrator username"
              }
            },
            "adminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Local administrator password"
              }
            },
            "aadJoinType": {
              "type": "string",
              "defaultValue": "AzureAD",
              "allowedValues": [
                "AzureAD",
                "ActiveDirectory"
              ],
              "metadata": {
                "description": "AAD join type: AzureAD or ActiveDirectory"
              }
            },
            "domainJoinUsername": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain join username (for ActiveDirectory)"
              }
            },
            "domainJoinPassword": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Domain join password (for ActiveDirectory)"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for VMs"
              }
            },
            "namingSuffix": {
              "type": "string",
              "metadata": {
                "description": "Naming suffix for VMs"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "vmNames",
                "count": "[length(range(0, parameters('numberOfHosts')))]",
                "input": "[format('{0}-vm-{1}-{2}', parameters('namingPrefix'), parameters('namingSuffix'), padLeft(string(add(range(0, parameters('numberOfHosts'))[copyIndex('vmNames')], 1)), 2, '0'))]"
              },
              {
                "name": "nicNames",
                "count": "[length(range(0, parameters('numberOfHosts')))]",
                "input": "[format('{0}-nic-{1}-{2}', parameters('namingPrefix'), parameters('namingSuffix'), padLeft(string(add(range(0, parameters('numberOfHosts'))[copyIndex('nicNames')], 1)), 2, '0'))]"
              },
              {
                "name": "diskNames",
                "count": "[length(range(0, parameters('numberOfHosts')))]",
                "input": "[format('{0}-disk-{1}-{2}', parameters('namingPrefix'), parameters('namingSuffix'), padLeft(string(add(range(0, parameters('numberOfHosts'))[copyIndex('diskNames')], 1)), 2, '0'))]"
              }
            ]
          },
          "resources": {
            "hostPool": {
              "existing": true,
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2023-09-05",
              "name": "[parameters('hostPoolName')]"
            },
            "nics": {
              "copy": {
                "name": "nics",
                "count": "[length(range(0, parameters('numberOfHosts')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-04-01",
              "name": "[variables('nicNames')[range(0, parameters('numberOfHosts'))[copyIndex()]]]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                      }
                    }
                  }
                ],
                "enableAcceleratedNetworking": true
              },
              "tags": "[parameters('tags')]"
            },
            "vms": {
              "copy": {
                "name": "vms",
                "count": "[length(range(0, parameters('numberOfHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-03-01",
              "name": "[variables('vmNames')[range(0, parameters('numberOfHosts'))[copyIndex()]]]",
              "location": "[parameters('location')]",
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                  "computerName": "[variables('vmNames')[range(0, parameters('numberOfHosts'))[copyIndex()]]]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]",
                  "windowsConfiguration": {
                    "enableAutomaticUpdates": true,
                    "provisionVMAgent": true,
                    "timeZone": "UTC"
                  }
                },
                "storageProfile": {
                  "imageReference": "[parameters('vmImage')]",
                  "osDisk": {
                    "name": "[variables('diskNames')[range(0, parameters('numberOfHosts'))[copyIndex()]]]",
                    "caching": "ReadWrite",
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "Premium_LRS"
                    },
                    "diskSizeGB": 127
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicNames')[range(0, parameters('numberOfHosts'))[range(0, parameters('numberOfHosts'))[copyIndex()]]])]",
                      "properties": {
                        "primary": true
                      }
                    }
                  ]
                },
                "licenseType": "Windows_Client"
              },
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[format('nics[{0}]', range(0, parameters('numberOfHosts'))[copyIndex()])]"
              ]
            },
            "aadJoinExtension": {
              "copy": {
                "name": "aadJoinExtension",
                "count": "[length(range(0, parameters('numberOfHosts')))]"
              },
              "condition": "[equals(parameters('aadJoinType'), 'AzureAD')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/AADLoginForWindows', variables('vmNames')[range(0, parameters('numberOfHosts'))[copyIndex()]])]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.ActiveDirectory",
                "type": "AADLoginForWindows",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "mdmId": "0000000a-0000-0000-c000-000000000000"
                }
              },
              "dependsOn": [
                "vms"
              ]
            },
            "avdAgentExtension": {
              "copy": {
                "name": "avdAgentExtension",
                "count": "[length(range(0, parameters('numberOfHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/AVDAgent', variables('vmNames')[range(0, parameters('numberOfHosts'))[copyIndex()]])]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.DesktopVirtualization",
                "type": "AVDAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "HostPoolName": "[parameters('hostPoolName')]",
                  "RegistrationToken": "[reference('hostPool').registrationInfo.token]"
                }
              },
              "dependsOn": [
                "aadJoinExtension",
                "hostPool",
                "vms"
              ]
            },
            "avdMonitoringExtension": {
              "copy": {
                "name": "avdMonitoringExtension",
                "count": "[length(range(0, parameters('numberOfHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/AVDMonitoring', variables('vmNames')[range(0, parameters('numberOfHosts'))[copyIndex()]])]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.DesktopVirtualization",
                "type": "AVDMonitoring",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {}
              },
              "dependsOn": [
                "avdAgentExtension",
                "vms"
              ]
            }
          },
          "outputs": {
            "vmNames": {
              "type": "array",
              "value": "[variables('vmNames')]"
            },
            "vmIds": {
              "type": "array",
              "value": "[map(references('vms', 'full'), lambda('vm', lambdaVariables('vm').id))]"
            },
            "numberOfHosts": {
              "type": "int",
              "value": "[parameters('numberOfHosts')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'hostpool-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[parameters('resourceGroupName')]"
    },
    "hostPoolName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'hostpool-deployment'), '2025-04-01').outputs.hostPoolName.value]"
    },
    "workspaceName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'workspace-deployment'), '2025-04-01').outputs.workspaceName.value]"
    },
    "workspaceUrl": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'workspace-deployment'), '2025-04-01').outputs.workspaceUrl.value]"
    },
    "dagName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'appgroup-deployment'), '2025-04-01').outputs.dagName.value]"
    },
    "vnetName": {
      "type": "string",
      "value": "[variables('vnetName')]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "expiry": {
      "type": "string",
      "value": "[parameters('expiry')]"
    }
  }
}